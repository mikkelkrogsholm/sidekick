<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="stylesheet" href="/styles/base.css" />
    <link rel="stylesheet" href="/styles/app.css" />
    <title>Voice Transcription Dashboard</title>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <div class="container topbar__inner">
                <div class="brand">
                    <img src="/logo.svg" alt="Voice Transcription Logo" style="height: 32px; width: auto;">
                    <h1 class="brand__title">Dashboard</h1>
                    <span class="brand__meta">Overview</span>
                </div>
                
                <div class="nav-links">
                    <a href="/dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="/" class="nav-link">Transcribe</a>
                    <a href="/viewer.html" class="nav-link">Viewer</a>
                </div>
                
                <div class="row">
                    <div class="badge">Session: <span id="currentSessionName">None</span></div>
                    <div class="row" id="health" aria-live="polite">
                        <div id="healthDot" class="dot" aria-hidden="true"></div>
                        <span id="healthText" class="meta">Checking…</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard">
            <div class="container stack">
                <section class="stats">
                    <div class="card stat">
                        <div class="kpi" id="totalSessions">0</div>
                        <div class="label">Sessions</div>
                    </div>
                    <div class="card stat">
                        <div class="kpi" id="totalTranscripts">0</div>
                        <div class="label">Transcripts</div>
                    </div>
                    <div class="card stat">
                        <div class="kpi" id="activeBuffers">0</div>
                        <div class="label">Active buffers</div>
                    </div>
                    <div class="card stat">
                        <div class="kpi" id="dbStatus">–</div>
                        <div class="label">Database</div>
                    </div>
                </section>

                <section class="card" style="padding: 8px 0;">
                    <div id="sessionsList"></div>
                </section>
            </div>
        </main>
    </div>
    
    <script>
        // Load current session from localStorage
        const currentSessionName = localStorage.getItem('currentSessionName') || 'None';
        document.getElementById('currentSessionName').textContent = currentSessionName;
        
        // Load stats from health endpoint
        async function loadStats() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('dbStatus').textContent = 'Online';
                    document.getElementById('totalTranscripts').textContent = data.stats.transcripts || 0;
                    document.getElementById('activeBuffers').textContent = data.stats.activeBuffers || 0;
                    
                    // Update health indicator
                    const healthEl = document.getElementById('health');
                    if (healthEl) {
                        healthEl.className = 'row healthy';
                        document.getElementById('healthText').textContent = 'System Healthy';
                    }
                } else {
                    const healthEl = document.getElementById('health');
                    if (healthEl) {
                        healthEl.className = 'row unhealthy';
                        document.getElementById('healthText').textContent = 'System Error';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                const healthEl = document.getElementById('health');
                if (healthEl) {
                    healthEl.className = 'row unhealthy';
                    document.getElementById('healthText').textContent = 'Connection Error';
                }
            }
        }
        
        // Load recent sessions
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();
                
                document.getElementById('totalSessions').textContent = sessions.length;
                
                const sessionsList = document.getElementById('sessionsList');
                if (sessions.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="row" style="padding: 20px; text-align: center; color: var(--color-text-muted);">
                            No sessions yet - create your first session to get started
                        </div>
                    `;
                } else {
                    sessionsList.innerHTML = '';
                    sessions.slice(0, 10).forEach(session => {
                        const date = new Date(session.created_at);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        const sessionRow = document.createElement('div');
                        sessionRow.className = 'row';
                        sessionRow.style.padding = '12px 16px';
                        sessionRow.style.borderBottom = '1px solid var(--color-border)';
                        sessionRow.style.justifyContent = 'space-between';
                        sessionRow.innerHTML = `
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--color-text-primary);">${escapeHtml(session.name)}</div>
                                <div style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 2px;">
                                    ${formattedDate} • ${session.total_transcripts} transcripts
                                </div>
                            </div>
                            <div class="row" style="gap: 8px;">
                                <button class="button" onclick="selectSession('${session.id}', '${escapeHtml(session.name)}')">
                                    Select
                                </button>
                                <a href="/viewer.html?sessionId=${session.id}" class="button">
                                    View
                                </a>
                                <button class="button button--danger" onclick="deleteSession('${session.id}', '${escapeHtml(session.name)}', ${session.total_transcripts})">
                                    Delete
                                </button>
                            </div>
                        `;
                        sessionsList.appendChild(sessionRow);
                    });
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Select a session
        function selectSession(sessionId, sessionName) {
            localStorage.setItem('currentSessionId', sessionId);
            localStorage.setItem('currentSessionName', sessionName);
            document.getElementById('currentSessionName').textContent = sessionName;
            alert(`Session "${sessionName}" selected!`);
        }
        
        // Show search modal (placeholder)
        function showSearchModal() {
            window.location.href = '/viewer.html';
        }
        
        // Select a session and save to localStorage
        window.selectSession = function(id, name) {
            localStorage.setItem('currentSessionId', id);
            localStorage.setItem('currentSessionName', name);
            
            // Update UI
            const sessionIndicator = document.getElementById('navSession');
            if (sessionIndicator) {
                const indicator = sessionIndicator.querySelector('.session-indicator');
                const text = sessionIndicator.querySelector('.session-text');
                indicator.classList.add('active');
                text.textContent = name;
            }
            
            // Show success message
            alert(`Session "${name}" selected!`);
        }
        
        // Delete a session
        window.deleteSession = async function(id, name, transcriptCount) {
            const message = transcriptCount > 0 
                ? `Are you sure you want to delete session "${name}"?\nThis will also delete ${transcriptCount} transcript chunk(s).\nThis action cannot be undone.`
                : `Are you sure you want to delete session "${name}"?\nThis action cannot be undone.`;
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete session');
                }
                
                const result = await response.json();
                console.log('Deleted session:', result);
                
                // If this was the current session, clear localStorage
                const currentSessionId = localStorage.getItem('currentSessionId');
                if (currentSessionId === id) {
                    localStorage.removeItem('currentSessionId');
                    localStorage.removeItem('currentSessionName');
                    
                    // Update UI to show no session
                    const sessionIndicator = document.getElementById('navSession');
                    if (sessionIndicator) {
                        const indicator = sessionIndicator.querySelector('.session-indicator');
                        const text = sessionIndicator.querySelector('.session-text');
                        indicator.classList.remove('active');
                        text.textContent = 'No Session';
                    }
                }
                
                // Reload sessions list
                loadSessions();
                
                // Update stats
                loadStats();
                
                // Show success message
                alert(`Session "${name}" has been deleted successfully.`);
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Failed to delete session. Please try again.');
            }
        }
        
        // Load data on page load
        loadStats();
        loadSessions();
        
        // Refresh stats every 10 seconds
        setInterval(loadStats, 10000);
    </script>
</body>
</html>